- name: Add Module Repository
  ansible.builtin.deb822_repository:
    name: nvidia-container-toolkit
    uris: "https://nvidia.github.io/libnvidia-container/stable/deb/amd64"
    signed_by: "https://nvidia.github.io/libnvidia-container/gpgkey"
    suites: [/]
    state: present
    enabled: yes

- name: Check if nvidia-smi and docker are present
  ansible.builtin.command: nvidia-smi && docker -v
  register: nvidia_smi
  changed_when: false
  failed_when: false

- name: Install NVIDIA Container Toolkit and dependencies at fixed version
  apt:
    name:
      - "nvidia-container-toolkit={{ nvidia_container_toolkit_version }}"
      - "nvidia-container-toolkit-base={{ nvidia_container_toolkit_version }}"
      - "libnvidia-container-tools={{ nvidia_container_toolkit_version }}"
      - "libnvidia-container1={{ nvidia_container_toolkit_version }}"
    state: present
    update_cache: yes
  when: nvidia_smi.rc == 0
  register: nvidia_toolkit_result

- name: Configure NVIDIA runtime for Docker
  shell: nvidia-ctk runtime configure --runtime=docker; systemctl restart docker
  when: nvidia_smi.rc == 0 and nvidia_toolkit_result is changed
