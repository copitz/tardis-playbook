---
# --- Required packages ---
- name: Install required packages for networking
  apt:
    name:
      - ifupdown2
      - vlan
    state: present
    update_cache: yes

- name: Fix missing file for ifupdown2
  become: yes
  ansible.builtin.shell:
    cmd: mkdir -p /etc/iproute2/rt_tables.d && touch /etc/iproute2/rt_tables.d/ifupdown2_vrf_map.conf
    creates: /etc/iproute2/rt_tables.d/ifupdown2_vrf_map.conf

# --- Network configuration ---

- name: Ensure /etc/network/interfaces has include directive
  copy:
    dest: /etc/network/interfaces
    content: |
      source /etc/network/interfaces.d/*

      auto lo
      iface lo inet loopback


- name: Configure LAN + SRV networking
  copy:
    dest: /etc/network/interfaces.d/net.cfg
    content: |
      # Main physical NIC (no IP, used by bridges/VLANs)
      auto {{ lan_iface }}
      allow-hotplug {{ lan_iface }}
      iface {{ lan_iface }} inet manual

      # LAN bridge (DHCP for host desktop)
      auto br-lan
      allow-hotplug br-lan
      iface br-lan inet dhcp
          bridge-ports {{ lan_iface }}
          bridge-stp off
          bridge-fd 0
          
      # Make sure the VLAN module is loaded before we touch vlan10
      pre-up modprobe 8021q

      # SRV VLAN interface (tagged VLAN {{ srv_vlan_id }})
      auto vlan{{ srv_vlan_id }}
      iface vlan{{ srv_vlan_id }} inet manual
          vlan-raw-device {{ lan_iface }}

      # SRV bridge (no IP on host, for Docker containers)
      auto br-srv
      iface br-srv inet static
          address {{ srv_address }}
          # gateway {{ srv_gateway }} # Keep the gateway commented out to not make this the default route
          bridge-ports vlan{{ srv_vlan_id }}
          bridge-stp off
          bridge-fd 0

          # Host must *not* route over br-srv
          post-up ip route del {{ srv_address | ansible.utils.ipaddr('network/prefix') }} dev br-srv 2>/dev/null || true
          post-up ip route add {{ srv_address | ansible.utils.ipaddr('network/prefix') }} dev br-srv metric 500
          post-down ip route del {{ srv_address | ansible.utils.ipaddr('network/prefix') }} dev br-srv || true

          # Prevent host DNS / multicast / Spotify fallback via br-srv
          post-up ip rule add iif br-srv lookup 100 unreachable
          post-down ip rule del iif br-srv lookup 100 unreachable || true

          post-up ip rule add oif br-srv lookup 100 unreachable
          post-down ip rule del oif br-srv lookup 100 unreachable || true

          # Optional but strong isolation: no ARP on this bridge
          post-up ip link set dev br-srv arp off
          post-down ip link set dev br-srv arp on
  register: net_config

- name: Restart networking if config changed
  command: ifreload -a
  when: net_config.changed


# --- Verify network connectivity (ping gateway) ---
- name: Refresh network facts if config changed
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Assert LAN is the default route
  ansible.builtin.assert:
    that: ansible_default_ipv4.interface == 'br-lan'
    success_msg: "LAN is the default route"
    fail_msg: "LAN is not the default route, current default route is via {{ ansible_default_ipv4.interface }}"

- name: Verify LAN connectivity
  vars:
    test_target: "{{ ansible_default_ipv4.gateway }}"
  ansible.builtin.command:
    cmd: "ping -I br-lan -c 2 -W 2 {{ test_target }}"
  register: ping_result
  changed_when: false
  failed_when: ping_result.rc != 0
  retries: 3
  delay: 2
  until: ping_result.rc == 0

# --- Docker networks ---
- name: "Ensure Docker SRV network exists and matches expected config"
  import_tasks: docker.yml
  vars:
    name: "{{ srv_network_name }}"
    parent: br-srv
    subnet: "{{ srv_address | ansible.utils.ipaddr('network/prefix') }}"
    gateway: "{{ srv_gateway }}"

- name: "Ensure Docker LAN network exists and matches expected config"
  import_tasks: docker.yml    
  vars:
    name: "{{ lan_network_name }}"
    parent: br-lan
    subnet: "{{ ansible_default_ipv4.network ~ '/' ~ ansible_default_ipv4.prefix }}"
    gateway: "{{ ansible_default_ipv4.gateway }}"
